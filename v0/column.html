<!DOCTYPE html>
<html>
  <head>
    <style>
      #title {
        font-family: sans-serif;
        font-size: 20px;
        font-weight: bold;
      }
      #subtitle {
        color: rgb(105, 105, 105);
        font-size: 14px;
        font-weight: normal;
      }
      #chart {

      }
    </style>
  </head>
  <body style="margin: 0">
    <div id="title" style="display: none">Chart Title</div>
    <div id="subtitle" style="display: none">Chart Subtitle</div>
    <br>
    <div id="chart-container" style="position: relative; width: 100%;">
      <canvas id="chart"></canvas>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script>
      const container = document.getElementById("chart-container");

      const searchParams = new URLSearchParams(window.location.search);

      const params = {
        url: searchParams.get("url"),
        backgroundColor: searchParams.get("backgroundColor"),
        color: searchParams.get("color"),
        data: searchParams.get("data"),
        data_type: searchParams.get("data_type"),
        currency: searchParams.get("currency"),
        height: searchParams.has("height") ? Number(searchParams.get("height")) : null,
        label: searchParams.get("label"),
        offset: searchParams.has("offset") ? Number(searchParams.get("offset")) : 0,
        order: searchParams.has("order") ? searchParams.get("order") : null,
        limit: searchParams.has("limit") ? Number(searchParams.get("limit")) : Infinity,
        title: searchParams.get("title"),
        subtitle: searchParams.get("subtitle"),
        tooltip: searchParams.has("tooltip") ? searchParams.get("tooltip") : null,
        width: searchParams.has("width") ? Number(searchParams.get("width")) : null,
      };

      console.log("params:", params);

      if (params.title) {
        document.getElementById("title").textContent = params.title;
        document.getElementById("title").style.display = null;
      }

      if (params.subtitle) {
        document.getElementById("subtitle").textContent = params.subtitle;
        document.getElementById("subtitle").style.display = null;
      }

      if (typeof params.height === "number") {
        container.style.height = params.height + "px";
      }

      if (typeof params.width === "number") {
        container.style.width = params.width + "px";
      }

      fetch(params.url)
        .then(function (response) { return response.json(); })
        .then(function (json) {
          console.log("json:", json);

          const items = json.slice(params.offset, params.offset + params.limit);

          if (typeof params.order === "string") {
            items.sort(function (a, b) {
              let order = params.order;

              let m = 1;
              if (order.startsWith("-")) {
                order = order.substring(1);
                m = -1;
              }

              a = a[params.order];
              b = b[params.order];
              if (typeof a === "string") a = new Date(a).getTime();
              if (typeof b === "string") b = new Date(b).getTime();
              if (a > b) return 1 * m;
              if (a === b) return 0;
              if (a < b) return -1 * m;
            });
          }

          const data = items.map(function (it) { return Number(it[params.data] || 0); });

          const labels = items.map(function (it) { return it[params.label] });

          console.log({data, labels});

          const canvas = document.getElementById('chart');


          Chart.register(ChartDataLabels);

          const chart = new Chart(canvas, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: params.backgroundColor,
                borderWidth: 1
              }]
            },
            options: {
              layout: {

              },
              plugins: {
                datalabels: {
                  anchor: "end",
                  align: "bottom",
                  color: params.color,
                  rotation: -90,
                  formatter: function (value, context) {
                    if (params.data_type === "currency") {
                      return value.toLocaleString("en-us", { style: "currency", currency: params.currency || "USD" });
                    } else {
                      return value.toLocaleString();
                    }
                  }
                },
                legend: false,
                tooltip: params.tooltip && {
                  xAlign: "center",
                  yAlign: "top",
                  callbacks: {
                    label: function (context) {
                      console.log("context:", context);
                      const value = items[context.datasetIndex][params.tooltip];
                      return params.tooltip + ": " + value;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value, index, ticks) {
                      if (value >= 1000 && value < 1000000) {
                        return value / 1000 + "K";
                      } else if (value >= 1000000 && value < 1000000000) {
                        return value / 1000000 + "M";
                      } else {
                        return value;
                      }
                    }
                  }
                }
              }
            }
          });
        });

    </script>
  </body>
</html>